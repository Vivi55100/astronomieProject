<?php 
    include_once "../../model/pdo.php";
    session_start();

//                                             ..--.       ...                                         
//                                            .=*-..      ..*:.                                        
//                                           .=#-.   ..   ..*-...                                      
//                                          .-#+..  .:.   ..+=-..                                      
//                                        . :#*... ..=-.  ..===..                                      
//                                        ..+#-.   .-*-    .===..                                      
//                                       ..:#*..  ..#=:    .=--.                                       
//                                       ..##-.+. .-#+.  ...+::..                                      
//                        ...            .-#*.-=. .+*+. .-..*::..                                      
//                    .....-....        ..=#+.--: .**+...+..+--.                                       
//                    :-::+:.=-:        ..*#-.---=****..:*..=-:.                                       
//                    ==:==-*-:.:..     ..##:-+-**##+*=-**.:-:.                           ...-.....:...
//                  ..*==*+#+==--..     .:##*#*=####**+*#+=--=.                            .=*::-..++-.
//                  .=++.:++-*+-.       ..=###*+####*=:*#***=-.                           ..**=-*.=**-.
//                  .+****#+-+=.          :####*#***+-==*+**=:.                           .-**.=#..**=.
//                  ..##%%#*#*:.         .-*##%%##-+=-:-*-+=...                          ..++=.**::#*=.
//                  ..*#*#*#*+...:..    ..=*###@#*#%*-%#=-+:                              :*++:*#-***=.
//                  ..*###***-.. =-..:.  ..****###**==++:=*:                            ..+**#%%####*=.
//                  .:#@@%%**-+..-+:.-=  ..*#%####%#-==++*..     ..                     .-#+*%@%*%##*=.
//                  ..******..+*::++--*:...-##%**%##+++++-..   ...:    ...            ...**+#%@%*###*=.
//                  .:**+++-..***=+**+#*:.=.%#%#*%++*+-*+..=....-:.....-.             ...+-+=%%#**%+*+.
//                  .-***+*-.:**########:=* *#%%*#=**=**..+=..==-...-+=...             ..+++:*##*#%**+:
//                  .=+++=*-..+*###%#*#####-#*%%#*=*+*+-.*+****#+-=:+:.:=.              .+=+.*##**#*+:.
//                  .+#*+=+=...*###+=+%%*#*%##%##=+*+++*#+*#*-#####=.:*=..              .==*:*#*#*#+=..
//                ..:*#*+=+*#******##%#*###%%%%##==*+++*###*-*#*###*+*:..               .=+*##%*%#*+:. 
//                ..=+*==++*%@@%**=*#++*#***#%%%%*+-.:++*#%%##+#####=..                 .:=*###*#*+-.. 
//                ..-*#*+++*#%@%*--#*-=-+-:=*#%%#*-=--:+***#@%*+*##*:.                    .-****+:.    
//                .=**==-=*%#**+###+=:==+-:::-*##*=:::-=**+**##+=***=..                   ..**==.      
//               ..=+***++###***#*==:.:*=.:...:---:=*=:-++=+*##+*=++*:.                    .+*+=..     
//               ...*###*++*####%%@=-++=:.:..:+=-....:*++**+%#+******+..                    +*+:.      
//                ...*#%##*###+*#*%*++=--=+#****+:...-.-#*=+++#******=..                   .**+..      
//                  .:-+**##%%%##%@#@@@@@@%%%##***+=:...-=+--++##***+=:..                  .*++..      
//                  ..-+=..:+*#%%#%@@@@@@@%%%###***++=--::--===@@%#+=..                   .:*+=.       
//                  .-++......#@@@@@@@@@@@@%##*##**++*++---=++*@@@@#+#:..                 .-*+-        
//                  ..=:..   .#@@@@@@@@@@@@%#*****++*+++*###%##@@@@%*#@#=..               .=*+:..      
//                           .#@@@@@@@@@@@@@#+*++++++++==+++##*%@@@@*+#@@%#=.             :**+:..      
//                           .#@@@@@@@@@@@@@@@*=====+=-+=+++##*#@@@@%*@%@@%=.        ...:-=**+-..      
//                           .#@@@@@@@@@@@@@@@%#*-:====+=+++##*%@@@@@##@#===--:.....:-+%%*+#**+=..     
//                         ..:%@@%@@@@@@@@@@@%%#**+=:-=+++++**%@@@@@@@#%%%#*#########%%%##=#+*--.      
//                          .=%@%%@@@@@%@@@@@%%#####***+**##%@@@@@@@@@@%%%###*#*#*#**%%#*%%*+*-:..     
//                          .+%%@@@@@@%%@@@@@%%###*=-+==+*++%@@@@@@@@%%@%@##%##*#****###**#***=-.      
//                         ..%%@@@@@@@@%@@@@%%###**==*==+*+*%@@@@@@@@*=+****==*=..++:.....**+-=:.      
//                         .*%@@@@@@@@%@@@@@%%###**+=+=++*++@@@@@@@@@*.  .-+-.-**-:==:...-*+=.         
//                         :%%@@@@@@@%@@@@@@%##***++=+=+++*+@@@@@@@@@@-....+**=......  ..+*+=.         
//                        .=%@@%@@@@@%@@@@%#%###*+++++=+****@%@@@@@@@@%.. ......      ...+*+-..        
//                        ..:*%%@@@@%%@@@%#+*****+--=+*++*###*@@@@@@@@@#..            ...**=:.         
//                         ..%%%@@@%%@@@@%*==*+**+-..---+**=%*=@@@@@@@@@+.            ...#+=..         
//                         .+%%@@@@%@@@@@%*+----==+-=.*++*--%***@@@@@@@@@=.           ..:*+-..         
//                         .#@%%%@%@@@@@@%%#*=:.---=:=+**+.+#*=-%@@@@@@@@%=..         ..-*=:           
//                        .=@%%%@%%@@@@@@%##*+-:.::=.=***++**%+-#@@@@@@@@@%-..        ..**=:           
//                       ..*%%%@%@@@@@@@@*#++=-=+:-:-=+=++**#@++*@@@@@@@@@%%=.        ..#+=.           
//                       .-%%%@@@@@@@@@%**+*==---=+:--++=+**#@%**%@@@@@@@@%+:.         .#+=.           
//                      .:%##%%@@@@@@@@@%+*-*=-:::--=-++:.*++++*##%@@@@@@@%:.         .=#=-.           
//                    ...+#%@@@%@@@%@%%@@%**+=:=:::**++=:=-=-=++=#*#@@@@@@@*.        ..**+:.           
//                    ..-%@@@@@@@@@#*@@%%###=-=::+%=++==:..+-==--#%+%@@@@@@%-.       ..**=:.           
//                   ..*@@@@@@@@@@@@@%%*#****+=:-++@*===-:.======#@#%@@@@@@@#..      .:#+=.            
//                 ...#@@@@@@@@@@@@@@%*#+*++-:++*=#%@++++=::*-=-==@#*@@@@@@@%+..     .:#+-.            
//                  .:%@@@@@@@@@@@@@@%#+*=--++--+*#%@@*+===+====+=+#*#@@@@@@@%..      ....             
//                  .#@@%%%@@@@@@@@@%###==.+=..=+#@@@@%*=======-===*%**@@@@@@%+.                       
//                  .#%%%%@@@@@@@@@#%####:=#+:-++%@@@@%%#+==-+-=*==+@%*%@@@@@@%..                      
//                  .*%%#@@@@@@@@%%###***###*=++*%@@@%@%##+======+-+*%*@@@@@@@%+..                     
//                 ..*%%%@@@@@@@@%#****%#+*+--+:#@@@@%@@%%#+=-=+-+=++**#@@@@@@%%-.                     
//                ...#%%@@@@@@@@@@#+*+%**-++==++#@@@@%@@@%%%+==*+=++%#**@@@@@@%%*...                   
//                ..*%%@@@@@@@@@@@@#+@#*+*%#+*++#@@@@%@@@@%%%*+*++**++#@@@@@@@@%%=.                    
//               ..+%%@@@@@@@@@@@@@@%%#**#*#**+*@@@@@@@@@@@@%%%#*+%*++#@@@@@@@@%%%-.                   
//               .-##@@@@@@@@@@@@@@%#%%%##****+%@@@@@@@@@@@%%%%#+*#*+**@@@@@@@@@%%#..                  
//              .:##%@@@@@@@@@@@@%%#*%##%##+**#@@@@@@@%@@@@@%#*#%*+***#%%%@@@@@@@%%+..                 
//             ..*#%%@@@@@@@@@@@@%@%%%##%%@%#*@@@@@@@@@@@@@%%@%#**+***#%%#*@@%@%@@%%*.                 
//             .-#%%@@@@@@@@@@@@@@@@%%#######%@@@@@@@@@@@@@@%##*##*+++%@@%#@@@@@@@%%%*..               
//            .:#%%%%@@@@@@@@@@@@@@@#=###**##@@@@@@@@@@@@@@%#****+%*+*%@@@%@@@@%%%@%%%#:..             
//           ..*%%@@@@@%@@@@@@@@@@@@#*###**#@@@@@@@@@@@@@@@%#****+#%#%@@@@@@@@@%%%%%%%%%#:..           
//          ..+%%%@@@@%%@@@@@@@@@@@%***###*@@@@@@@@@@@@@@@@##******+#@@@@@@@@@@@@%%%%%%%%%%=..         
//         ..=%%%@@@@%%@@@@@@@@@%%%##*+*+*%@@@@@@@@@@@@@@@@#***+***+*@@@@@@@@@@@@%%%%%%%%%%%*..        
//        ..=%@%%@@%@%@@@@@@@@@@@%#*#%#*%@@@@@@@@@@@@@@@@@%#***+**##*=@@@@@@@@@@@@%%%%%%%%%%%*..       
//        .-%@%%%@%%%%@@@@@@@@@%%%#*%%%%%@@@@@@@@@@@@@@@@@#********%%#**@@@@@@@@@@@%%%%%%%%%%#.        
//      ..-%@%%%@@%%%@@@@@@@@@%%%#*##*###@@@@@@@@@%@@%@@@@%***++**#@@++@@@@@@@@@@@%%%%%%%%%%%-..       
//     ..:%@%%%@%%%%%%@@@@@@@@@%#**#*+**%@@@@@@@@%%%%%@@@%#***+**#%@@#%@@@@@@@@@@@%%%%%%%%%%+..        
//     .:%@%%%%%%%%%@@@@@@@@@@%%#**#*+*%@@@@@@@@@%%%%%%%@%#******###%@@@@@@@@@@@@@%%%%%%%%%*..         
//   ...*@%%%%%%%%%%@@@@@@@@@%%###%%#*@@@@@@@@@@%%%%%%%%@%#*#****%%+#@@@@%%%%%%@@@@@%%%%%%*..          
//   ..+%@%%%%%%%%%%@@@@@@@@%%#####%#*@@@@@@%@@@%%%%%%%%%%#***#**%%#%%##%%%+#%%%@@@@@%%*##..           
//   .-%@@%%%@%@%@%%@@@@@@@@#####**#*@@@@@*.-%@#=.:=+*%*#%#****##*=-:..........%%#-+##:....            
//  ..*@@%%%@@@@@%%%@@@@%@@%%*##**+*%@%#%%=..+*...    . .:##****++..          ......                   
// ..+%@@%%%@@@@%%%%@@@@@@%%%#-##*+.-*:.... ...         .-%****+...                                    
// .*%%@@@%%@@@%%%%%%%%%@@%%%###%*.. ...               . =%***#-=..                                    
// -%@%%@@%%@%%#---:%*.:+*@%#+***-..                   ..%%###*:=+:..                                  
// :%%%%@%%%%+..   ... ..-%#**+++..                     :###**#*++##*-:....                            
// ..%%@@@%*..         ..*%#*+##-                       .###*****#####%%##=.......                     
// ..*%%%%*...         ..+#*=::*.                       .#*****##%#*##+++*#*###*=...                   
//  ..=%-...          .:#%%*-:.=..                    ...####**#########*=+=--==:..                    
//   . ..             .*%%%+=--+.                      ..-=++**###########***+=...                     
//                    -%%@@##*##=                        .     ........:::-=+=..                       
//                  ..*%%%%%#####-.                                                                    
//                 ..=*%%%#%%#####-..                                                                  
//                  .+**#%#####%%%#:.                                                                  
//                  ..:******##**#*=.                                                                  
//                    ..:+*********=.                                                                  
//                      ....-+***+-..                                                                  

if (!empty($_POST["oldpsw"]) && !empty($_POST["newpsw"])) {
  $id = $_POST['id_user'];
  $sql_old_psw = "SELECT password FROM User WHERE id_user=$id";
  $stmt_old_psw = $pdo->query($sql_old_psw);
  $password = $stmt_old_psw->fetch(PDO::FETCH_ASSOC);
  $password = $password['password'];
    if (password_verify($_POST["oldpsw"], $password)){
        if ($_POST["oldpsw"] != $_POST["newpsw"]) {
            $psw = password_hash($_POST["newpsw"], PASSWORD_ARGON2I);
            try {
                $sql = "UPDATE User SET password=? WHERE id_user=? ";
                $stmt = $pdo->prepare($sql);
                if ($stmt->execute([$psw, $id])) {
                    echo "<h2>Le mot de passe à été modifié avec succes</h2>";
                    header('Location:../../view/home/home.php');
                } else {
                    echo "<h2>Probleme technique</h2>";
                    header('Location:../../view/user/update_user.php');
                }
            }catch (PDOException $e) {
                echo "<h2>Il y'a quelque chose qui s'est mal passé: </h2>". $e->getMessage();
                header("Location:../../view/user/update_user.php");
            }    
        }else {
            echo "<h2>Vos modifications ont echouées</h2>";
        }    
    }else {
        echo "<h2>Mot de passe incorrect</h2>";
    }
}else {
    echo "<h2>La modification a échouées</h2>";
}